<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doa√ß√£o na Lixeira - Ecoltarema</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Biblioteca para leitura de QR Code -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1db954, #1aa34a);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: #f4fef5;
      border-radius: 20px;
      padding: 20px 30px 40px 30px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      animation: fadeInUp 1s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      font-weight: 600;
      color: #222;
      margin-bottom: 15px;
      font-size: 26px;
    }

    #usuarioInfo {
      color: #444;
      font-size: 16px;
      margin-bottom: 20px;
      word-wrap: break-word;
    }

    label {
      font-weight: 600;
      color: #333;
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
      text-align: left;
    }

    select,
    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      font-size: 15px;
    }

    button {
      background: #1db954;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 0;
      width: 100%;
      transition: background 0.3s;
    }

    button:hover {
      background: #17a44d;
    }

    #reader {
      width: 100%;
      margin: 15px 0;
      display: none;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 15px;
    }

    li {
      background: #e6f4e9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Doa√ß√£o na Lixeira</h1>
    <p id="usuarioInfo">Carregando...</p>

    <label for="tipoReciclavel">Tipo de Recicl√°vel</label>
    <select id="tipoReciclavel">
      <option value="">Selecione</option>
      <option value="Pl√°stico">Pl√°stico</option>
      <option value="Vidro">Vidro</option>
      <option value="Papel">Papel</option>
      <option value="Metal">Metal</option>
      <option value="Eletr√¥nico">Eletr√¥nico</option>
    </select>

    <label for="tipoQuantidade">Doar por</label>
    <select id="tipoQuantidade" onchange="atualizarPlaceholderQuantidade()">
      <option value="quilo" selected>Quilo (kg)</option>
      <option value="unidade">Unidade</option>
    </select>

    <label for="quantidade">Quantidade</label>
    <input type="number" id="quantidade" min="0.01" step="0.01" placeholder="Digite a quantidade em kg">

    <label for="lixeira">Local da Lixeira</label>
    <select id="lixeira">
      <option value="">Selecione o ponto de coleta</option>
      <option value="Escola Municipal Itarema">Escola Municipal Itarema</option>
      <option value="Pra√ßa Central">Pra√ßa Central</option>
      <option value="Mercado P√∫blico">Mercado P√∫blico</option>
      <option value="Secretaria de Meio Ambiente">Secretaria de Meio Ambiente</option>
      <option value="Posto de Sa√∫de">Posto de Sa√∫de</option>
    </select>

    <button onclick="lerQRCode()">üì∑ Ler QR Code</button>
    <div id="reader"></div>
    <p id="statusQR" style="color:#1aa34a; font-weight:600;"></p>

    <button onclick="enviarDoacao()">Registrar Doa√ß√£o</button>
    <button onclick="irPara('menu.html')">Voltar ao Menu</button>
    <button onclick="irPara('ranking.html')">Ver Ranking</button>

    <h3 style="margin-top:20px;">Minhas Doa√ß√µes</h3>
    <ul id="minhasDoacoes">Carregando...</ul>
  </div>

  <script>
    // --- Login ---
    const email = localStorage.getItem("usuarioLogado") || sessionStorage.getItem("usuarioLogado");

    if (!email) {
      alert("Voc√™ precisa estar logado para acessar esta p√°gina.");
      window.location.href = "login.html";
    }

    const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
    const usuario = usuarios.find(u => u.email === email);

    if (!usuario) {
      alert("Usu√°rio n√£o encontrado. Fa√ßa login novamente.");
      window.location.href = "login.html";
    } else {
      document.getElementById("usuarioInfo").innerText = `Logado como: ${usuario.nome} | Tipo: ${usuario.tipo}`;
    }

    // --- Controle de QR Code ---
    let qrValido = false;
    let scanner = null;

    function lerQRCode() {
      const readerDiv = document.getElementById("reader");
      readerDiv.style.display = "block";
      document.getElementById("statusQR").innerText = "Aponte a c√¢mera para o QR Code da lixeira...";

      scanner = new Html5Qrcode("reader");
      scanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        qrCodeMessage => {
          qrValido = true;
          document.getElementById("statusQR").innerText = "‚úÖ QR Code v√°lido lido com sucesso!";
          scanner.stop();
          readerDiv.style.display = "none";
        },
        errorMessage => {
          // Ignora erros enquanto tenta ler
        }
      ).catch(err => {
        alert("Erro ao acessar c√¢mera: " + err);
      });
    }

    function irPara(pagina) {
      window.location.href = pagina;
    }

    function atualizarPlaceholderQuantidade() {
      const tipoQuant = document.getElementById("tipoQuantidade").value;
      const inputQtd = document.getElementById("quantidade");
      if (tipoQuant === "quilo") {
        inputQtd.placeholder = "Digite a quantidade em kg";
        inputQtd.step = "0.01";
        inputQtd.min = "0.01";
      } else {
        inputQtd.placeholder = "Digite a quantidade em unidades";
        inputQtd.step = "1";
        inputQtd.min = "1";
      }
    }

    function enviarDoacao() {
      let tipo = document.getElementById("tipoReciclavel").value;
      let tipoQuantidade = document.getElementById("tipoQuantidade").value;
      let quantidade = parseFloat(document.getElementById("quantidade").value);
      let lixeira = document.getElementById("lixeira").value;

      if (!tipo || !tipoQuantidade || !quantidade || !lixeira) {
        alert("Preencha todos os campos.");
        return;
      }

      if (!qrValido) {
        alert("Voc√™ precisa ler o QR Code da lixeira antes de registrar a doa√ß√£o!");
        return;
      }

      let doacoes = JSON.parse(localStorage.getItem("doacoes")) || [];
      doacoes.push({
        tipo,
        tipoQuantidade,
        quantidade,
        localizacao: lixeira,
        doador: usuario.email,
        status: "Entregue (Lixeira)"
      });
      localStorage.setItem("doacoes", JSON.stringify(doacoes));

      alert("‚úÖ Doa√ß√£o registrada com sucesso! Obrigado por contribuir.");
      qrValido = false; // Reseta a leitura
      document.getElementById("statusQR").innerText = "";
      carregarMinhasDoacoes();

      document.getElementById("tipoReciclavel").value = "";
      document.getElementById("tipoQuantidade").value = "quilo";
      atualizarPlaceholderQuantidade();
      document.getElementById("quantidade").value = "";
      document.getElementById("lixeira").value = "";
    }

    function carregarMinhasDoacoes() {
      let doacoes = JSON.parse(localStorage.getItem("doacoes")) || [];
      let minhas = doacoes.filter(d => d.doador === usuario.email);
      let lista = document.getElementById("minhasDoacoes");
      lista.innerHTML = "";
      if (minhas.length === 0) {
        lista.innerHTML = "<li>Nenhuma doa√ß√£o registrada.</li>";
        return;
      }

      minhas.forEach((d) => {
        let li = document.createElement("li");
        li.innerHTML = `
          <b>${d.tipo}</b> - ${d.quantidade} ${d.tipoQuantidade === "quilo" ? "kg" : "unidades"}<br>
          <b>Local:</b> ${d.localizacao}<br>
          <b>Status:</b> ${d.status}
        `;
        lista.appendChild(li);
      });
    }

    carregarMinhasDoacoes();
  </script>
</body>
</html>

